!function(t){t.JCIblockVoteStars||(t.JCIblockVoteStars=function(t){this.progressObj=null,this.ratingObj=null,this.starsObj=null,this.progressId="",this.ratingId="",this.starsId="",this.ajaxParams={},this.siteId="",this.voteData={element:0,percent:0,count:0},this.config={readOnly:!1,alreadyVoted:!0,request:!1},BX.type.isPlainObject(t)&&(BX.type.isNotEmptyString(t.progressId)&&(this.progressId=t.progressId),BX.type.isNotEmptyString(t.ratingId)&&(this.ratingId=t.ratingId),BX.type.isNotEmptyString(t.starsId)&&(this.starsId=t.starsId),BX.type.isNotEmptyString(t.ajaxUrl)&&(this.ajaxUrl=t.ajaxUrl),BX.type.isNotEmptyString(t.checkVoteUrl)&&(this.checkVoteUrl=t.checkVoteUrl),BX.type.isPlainObject(t.ajaxParams)&&(this.ajaxParams=t.ajaxParams),BX.type.isNotEmptyString(t.siteId)&&(this.siteId=t.siteId),BX.type.isPlainObject(t.voteData)&&(BX.type.isNumber(t.voteData.element)&&(this.voteData.element=t.voteData.element),BX.type.isNumber(t.voteData.percent)&&(this.voteData.percent=this.preparePercent(t.voteData.percent)),BX.type.isNumber(t.voteData.count)&&(this.voteData.count=t.voteData.count)),BX.type.isBoolean(t.readOnly)&&(this.config.readOnly=t.readOnly)),BX.ready(BX.proxy(this.init,this))},t.JCIblockVoteStars.prototype.init=function(){BX.type.isNotEmptyString(this.progressId)&&(this.progressObj=BX(this.progressId)),BX.type.isNotEmptyString(this.ratingId)&&(this.ratingObj=BX(this.ratingId)),BX.type.isNotEmptyString(this.starsId)&&(this.starsObj=BX(this.starsId)),this.showProgress(this.voteData.percent),this.showVotes(),this.checkVote()},t.JCIblockVoteStars.prototype.checkVote=function(){this.config.readOnly||this.voteData.element<=0||BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.checkVoteUrl,data:{sessid:BX.bitrix_sessid(),checkVote:"Y",vote_id:this.voteData.element,site_id:this.siteId},onsuccess:BX.proxy(this.checkVoteResult,this)})},t.JCIblockVoteStars.prototype.checkVoteResult=function(t){BX.type.isPlainObject(t)&&t.success&&(this.config.alreadyVoted=t.voted),this.config.readOnly||this.config.alreadyVoted||this.voteData.element<=0||BX.type.isElementNode(this.starsObj)&&(console.log(this.starsObj.parentNode),BX.bind(this.starsObj.parentNode,"mousemove",BX.proxy(this.handlerMouseMove,this)),BX.bind(this.starsObj.parentNode,"mouseout",BX.proxy(this.handlerMouseOut,this)),BX.bind(this.starsObj.parentNode,"click",BX.proxy(this.handlerClick,this)))},t.JCIblockVoteStars.prototype.destroy=function(){BX.type.isElementNode(this.progressObj)&&BX.unbindAll(this.progressObj),this.progressObj=null,BX.type.isElementNode(this.ratingObj)&&BX.unbindAll(this.ratingObj),this.ratingObj=null,BX.type.isElementNode(this.starsObj)&&BX.unbindAll(this.starsObj),this.starsObj=null},t.JCIblockVoteStars.prototype.preparePercent=function(t){return t=parseInt(t,10),isNaN(t)?t=0:t>100?t=100:t<0&&(t=0),t},t.JCIblockVoteStars.prototype.showProgress=function(t){BX.type.isElementNode(this.progressObj)&&BX.style(this.progressObj,"width",t.toString()+"%")},t.JCIblockVoteStars.prototype.showVotes=function(){BX.type.isElementNode(this.ratingObj)&&(this.ratingObj.innerHTML="( "+this.voteData.count+" )")},t.JCIblockVoteStars.prototype.handlerMouseMove=function(e){var s,i;console.log(this.config),this.config.readOnly||this.config.alreadyVoted||this.config.request||(e=e||t.event,BX.type.isElementNode(this.starsObj)&&(s=BX.pos(this.starsObj),i=(e.pageX-s.left)/s.width*5,this.showProgress(this.preparePercent(20*Math.ceil(i)))))},t.JCIblockVoteStars.prototype.handlerMouseOut=function(){this.config.readOnly||this.config.alreadyVoted||this.config.request||this.showProgress(this.voteData.percent)},t.JCIblockVoteStars.prototype.handlerClick=function(e){var s,i;this.config.readOnly||this.config.alreadyVoted||this.config.request||(this.config.request=!0,e=e||t.event,BX.type.isElementNode(this.starsObj)&&(s=BX.pos(this.starsObj),i=parseInt(Math.ceil((e.pageX-s.left)/s.width*5),10),isNaN(i)||(this.ajaxParams.rating=i-1,this.ajaxParams.vote="Y",this.ajaxParams.vote_id=this.voteData.element,this.ajaxParams.sessid=BX.bitrix_sessid(),this.ajaxParams.site_id=this.siteId,BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:this.ajaxParams,onsuccess:BX.proxy(this.clickResult,this)}))))},t.JCIblockVoteStars.prototype.clickResult=function(t){this.config.request=!1,BX.type.isPlainObject(t)&&(this.config.alreadyVoted=!0,this.voteData.percent=this.preparePercent(20*t.value),this.voteData.count=t.votes,this.showProgress(this.voteData.percent),this.showVotes())})}(window);